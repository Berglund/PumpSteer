# PumpSteer

PumpSteer √§r en anpassad Home Assistant-integration f√∂r att dynamiskt optimera din v√§rmepump genom att manipulera insignalen fr√•n utomhustemperatursensorn. Den l√•ter dig spara energi och pengar genom att anpassa din uppv√§rmningsstrategi baserat p√• elpriser, inomhustemperatur och v√§derprognoser.

-----

## ‚úÖ Funktioner

  - üîß **Smart virtuell styrning av utomhustemperatur**
  - ‚ö° Anpassar uppv√§rmningsstrategin baserat p√•:
      - Inomhustemperatur
      - M√•ltemperatur
      - Prognos f√∂r elpris
      - Temperaturprognos
  - üå°Ô∏è Fejkat utomhustemperatur ber√§knas f√∂r att lura v√§rmepumpen att spara eller buffra energi
  - üöÄ **Pre-boost-l√§ge:** bygg upp en v√§rmebuffert f√∂re kalla och dyra pristoppar
  - üßä **Bromsl√§ge:** undvik uppv√§rmning under de dyraste timmarna
  - üèñÔ∏è **Sommarl√§ge:** inaktiverar fejkad temperatur n√§r utomhustemperaturen √§r √∂ver tr√∂skelv√§rdet
  - üèùÔ∏è **Semesterl√§ge:** N√§r semesterl√§get √§r aktiverat och aktuell tid ligger inom de valda datumen, s√§nks inomhustemperaturen till 16 grader tills du √§r tillbaka.
  - üì¶ **Enkel installation** med medf√∂ljande `packages`-fil f√∂r hj√§lpentiteter
  - üìä Helt lokalt (inga molnberoenden)
  - üß† Sj√§lvjusterande ber√§kning av husets tr√∂ghet
  - üîÑ St√∂der komfortprofiler via en aggressivitetsinst√§llning
  - üìà ApexCharts-exempel ing√•r f√∂r visualisering

-----

> **Obs\!**
> Semesterl√§ge √§r endast aktivt n√§r sommarl√§ge *inte* √§r aktivt.
> Om utomhustemperaturen √§r √∂ver sommar-tr√∂skeln kommer sommarl√§get alltid att prioriteras √∂ver semesterl√§get.
> Detta inneb√§r att uppv√§rmningen minimeras under varma perioder, √§ven om semesterl√§get √§r aktiverat.

-----

## L√§gg till PumpSteer till HACS som ett anpassat arkiv (Custom Repository)

Om PumpSteer √§nnu inte finns tillg√§ngligt i HACS standardbutik kan du l√§gga till det manuellt som ett anpassat arkiv:

I Home Assistant, g√• till HACS i sidof√§ltet.
Klicka p√• menyn med tre punkter (‚ãÆ) i det √∂vre h√∂gra h√∂rnet och v√§lj "Custom repositories" (Anpassade arkiv).
I f√§ltet "Repository" (Arkiv), ange:

```
https://github.com/JohanAlvedal/PumpSteer
```

St√§ll in kategorin till "Integration".
Klicka p√• "Add" (L√§gg till).
PumpSteer kommer nu att visas under HACS \> Integrations. Klicka p√• "Install" f√∂r att l√§gga till det.
Starta om Home Assistant efter installationen.
Forts√§tt med konfigurationsstegen som beskrivits ovan.
Obs:
S√• l√§nge PumpSteer inte finns i den officiella HACS-butiken m√•ste du upprepa dessa steg om du installerar om HACS eller rensar dess konfiguration.

-----

## üîß Installation och Konfiguration

F√∂lj dessa tre steg f√∂r att f√• PumpSteer ig√•ng.

### Steg 1: Skapa hj√§lpentiteter (via Packages)

F√∂r att g√∂ra installationen s√• enkel som m√∂jligt, inneh√•ller detta projekt en paketfil som skapar alla n√∂dv√§ndiga `input_number`- och `input_text`-hj√§lpare √•t dig.

1.  **Ladda ner filen `pumpsteer_package.yaml`** fr√•n arkivet.

2.  Placera filen i din `/config/packages/` katalog. Om `packages`-katalogen inte finns i roten av din `/config`-mapp, m√•ste du skapa den.

3.  **Aktivera packages** i din huvudsakliga `configuration.yaml`-fil. Om du inte redan har gjort det, l√§gg till f√∂ljande rader. Om du redan har en `homeassistant:`-sektion, l√§gg bara till `packages:`-raden till den.

    ```yaml
    homeassistant:
      packages: !include_dir_named packages
    ```

4.  **Starta om Home Assistant.** Efter omstart kommer alla n√∂dv√§ndiga hj√§lpare (listade i avsnittet "Referens f√∂r hj√§lpentiteter" nedan) att vara tillg√§ngliga.

### Steg 2: Installera den anpassade komponenten

Detta √§r standardproceduren f√∂r att installera en anpassad komponent.

1.  Placera katalogen `pumpsteer` (som inneh√•ller `sensor.py`, `pre_boost.py`, etc.) i din Home Assistant-mapp `custom_components`.
2.  Starta om Home Assistant igen.

### Steg 3: L√§gg till integrationen

1.  Navigera till **Inst√§llningar \> Enheter och Tj√§nster \> L√§gg till Integration**.
2.  S√∂k efter och v√§lj **PumpSteer**.
3.  I konfigurationsdialogen, v√§lj de hj√§lpentiteter som skapades av paketfilen.

-----

## üìÑ Referens f√∂r hj√§lpentiteter

Genom att anv√§nda den medf√∂ljande filen `pumpsteer_package.yaml` kommer f√∂ljande entiteter att skapas. Du kan justera deras v√§rden fr√•n Home Assistant-gr√§nssnittet under **Inst√§llningar \> Enheter och Tj√§nster \> Hj√§lpare**.

| Typ | Beskrivning |
| :--- | :--- |
| `sensor` | Inomhustemperaturgivare (m√•ste du tillhandah√•lla) |
| `sensor` | Verklig utomhustemperaturgivare (m√•ste du tillhandah√•lla) |
| `sensor` | Elprissensor (m√•ste du tillhandah√•lla, t.ex. Nordpool eller Tibber) |
| `input_text` | Lagrar de timvisa prognostiserade temperaturerna (CSV-str√§ng, 24 v√§rden) |
| `input_number`| Din √∂nskade m√•linomhustemperatur |
| `input_number`| Utomhustemperaturtr√∂skeln f√∂r att aktivera sommarl√§ge |
| `input_number` | Aggressivitetsniv√•n f√∂r besparingar vs. komfort (0,0 till 5,0) |
| `input_number` | Den ber√§knade husets tr√∂ghet (du kan l√•ta PumpSteer hantera detta eller √•sidos√§tta det) |

-----

## üß™ Prognosformat

`input_text`-entiteten f√∂r temperaturprognosen m√•ste inneh√•lla **h√∂gst 24 kommaseparerade v√§rden** som representerar de timvisa prognostiserade utomhustemperaturerna f√∂r de kommande 24 timmarna:

```text
-3.5,-4.2,-5.0,-4.8,... (totalt 24 v√§rden)
```

Om str√§ngen √§r ogiltig eller ofullst√§ndig, kommer sensorn att logga en varning och tillf√§lligt avbryta ber√§kningarna tills giltig data √§r tillg√§nglig.

-----

## üìä Sensorutg√•ngar

PumpSteer skapar tv√• sensorer.

### 1\. `sensor.pumpsteer` (Kontrollsensor)

Denna sensor tillhandah√•ller den ber√§knade virtuella temperaturen.

**Tillst√•nd:** Den fejkade utomhustemperaturen (`¬∞C`) som ska skickas till din v√§rmepump.

**Attribut:**

| Attribut | Betydelse |
| :--- | :--- |
| `L√§ge` | Aktuellt driftl√§ge. Kan vara: `heating`, `neutral`, `braking_by_temp`, `summer_mode`, `preboost`, `braking_mode` |
| `Ute (verklig)` | Aktuell temperatur fr√•n den verkliga utomhussensorn |
| `Inne (m√•l)` | Din √∂nskade inomhustemperatur |
| `Inne (verklig)` | Aktuell inomhustemperatur |
| `Inertia` | Hur l√•ngsamt huset reagerar p√• f√∂r√§ndringar i utomhustemperaturen (h√∂gre = b√§ttre isolerat) |
| `Aggressiveness` | Fr√•n 0,0 (passiv) till 5,0 (aggressiv besparing) |
| `Summer threshold` | Utomhustemperaturtr√∂skeln f√∂r att inaktivera v√§rmekontroll |
| `Elpriser (prognos)` | Timvisa elpriser fr√•n din prissensor |
| `Pre-boost Aktiv` | Sant om pre-boost eller bromsning √§r aktiv (pausar tr√∂ghetsber√§kningen) |

### 2\. `sensor.pumpsteer_future_strategy` (Diagnossensor)

Denna sensor ger insikter om *varf√∂r* systemet fattar sina beslut.

**Tillst√•nd:**
Antalet kommande timmar som identifierats som b√•de kalla och dyra.

**Attribut:**

| Attribut | Betydelse |
| :--- | :--- |
| `preboost_expected_in_hours` | Hur m√•nga timmar i f√∂rv√§g systemet kommer att starta pre-boost, baserat p√• husets tr√∂ghet. |
| `first_preboost_hour` | Klockslaget (t.ex. "18:00") f√∂r n√§sta f√∂rv√§ntade pre-boost-h√§ndelse. |
| `cold_and_expensive_hours_next_6h` | Totalt antal timmar identifierade som "kalla & dyra" under de n√§rmaste 6 timmarna. |
| `expensive_hours_next_6h` | Totalt antal timmar som anses "dyra" under de n√§rmaste 6 timmarna. |
| `braking_price_threshold_percent` | Aktuell pristr√∂skel (i % av maxpris) f√∂r att aktivera bromsl√§ge. |

-----

## Aggressivitet ‚Äì Vad g√∂r den?

Aggressivitet (0,0 till 5,0) styr avv√§gningen mellan energibesparingar och inomhuskomfort. Den p√•verkar b√•de n√§r uppv√§rmningen minskas (bromsning) och n√§r extra uppv√§rmning l√§ggs till (pre-boost).

| Inst√§llning | Bromsbeteende | Pre-boost-beteende |
| :--- | :--- | :--- |
| **L√•g** (t.ex. 0-1) | Bromsar s√§llan, endast vid de absolut h√∂gsta priserna. | √ñkar l√§ttare f√∂r att prioritera komfort. |
| **H√∂g** (t.ex. 4-5) | Bromsar tidigt och ofta, √§ven vid m√•ttliga pristoppar. | √ñkar endast i de mest n√∂dv√§ndiga fallen f√∂r att spara energi. |

**H√∂gre aggressivitet sparar mer pengar, men kan minska inomhuskomforten.**

-----

## üìà ApexCharts Exempel

### Visualisera temperaturer

```yaml
type: custom:apexcharts-card
header:
  title: PumpSteer Temperaturkontroll
graph_span: 24h
span:
  start: day
series:
  - entity: sensor.pumpsteer
    name: Fejkad utomhustemp
  - entity: sensor.ute_verklig_temp
    name: Verklig utomhustemp
  - entity: sensor.inne_verklig_temp
    name: Inomhustemp
  - entity: input_number.varmepump_target_temp
    name: M√•ltemp
    stroke_width: 2
    curve: stepline
```

### Visualisera framtida strategi

```yaml
type: custom:apexcharts-card
header:
  title: PumpSteer - Framtida hot
chart_type: bar
graph_span: 24h
series:
  - entity: sensor.pumpsteer_future_strategy
    name: Kalla & dyra timmar
    attribute: cold_and_expensive_hours_next_6h
  - entity: sensor.pumpsteer_future_strategy
    name: Dyra timmar
    attribute: expensive_hours_next_6h
```

-----

## üß† Hur det fungerar

PumpSteer ber√§knar en "fejkad" utomhustemperatur f√∂r att knuffa din v√§rmepump till att antingen:

  - **Pre-boosta:** V√§rma mer n√§r priser och temperaturer √§r l√•ga, f√∂re en kommande kall och dyr pristopp.
  - **Bromsa:** Undvika uppv√§rmning n√§r priserna √§r som h√∂gst.
  - **Normalt:** Justera f√∂rsiktigt uppv√§rmningen f√∂r att bibeh√•lla komfort med minimal kostnad.
  - **Sommarl√§ge:** St√• ner n√§r det √§r varmt ute.

-----

## üí¨ Loggning och Fels√∂kning

  - Varningar och fel loggas i standardloggen f√∂r Home Assistant.
  - Om n√∂dv√§ndig sensordata inte √§r tillg√§nglig, kommer PumpSteer att visa `unavailable` och f√∂rs√∂ka igen automatiskt.
  - Husets tr√∂ghetsv√§rde ber√§knas och uppdateras automatiskt om du inte anger en manuell √•sidos√§ttning via ett `input_number`.

-----

## En notering fr√•n utvecklaren

Denna integration har byggts av en amat√∂rutvecklare med kraftfull assistans av Googles Gemini och Copilot. Det √§r resultatet av en passion f√∂r smarta hem, mycket trial and error, och m√•nga, m√•nga omstarter av Home Assistant.

V√§nligen betrakta detta som en **betaprodukt** i ordets sannaste bem√§rkelse.

Om du √§r kunnig inom detta omr√•de v√§lkomnas konstruktiv feedback, f√∂rslag och bidrag varmt. Var t√•lmodig, d√• detta √§r ett l√§rande projekt.

-----

## üîó L√§nkar

  - [√Ñrendehanterare](https://github.com/JohanAlvedal/pumpsteer/issues)

-----

## üìÑ Licens

¬© Johan √Ñlvedal

# PumpSteer

PumpSteer is a custom Home Assistant integration for dynamically optimizing your heat pump by manipulating the outdoor temperature sensor input. It allows you to save energy and money by adapting your heating strategy based on electricity prices, indoor temperature, and weather forecasts.

-----

## ‚úÖ Features

  - üîß **Smart virtual outdoor temperature control**
  - ‚ö° Adjusts heating strategy based on:
      - Indoor temperature
      - Target temperature
      - Electricity price forecast
      - Temperature forecast
  - üå°Ô∏è Fake outdoor temperature is calculated to trick the heat pump into saving or buffering energy
  - üöÄ **Pre-boost mode:** build up a heat buffer before cold and expensive price peaks
  - üßä **Braking mode:** avoid heating during the most expensive hours
  - üèñÔ∏è **Summer mode:** disables fake temperature when the outdoor temp is above the threshold
  - üèùÔ∏è **Holiday Mode:** When Holiday Mode is on and the current time is within the selected dates, it will lower indoor temp to 16 degrees until you‚Äôre back.
  - üì¶ **Easy setup** with a provided `packages` file for helper entities
  - üìä Fully local (no cloud dependencies)
  - üß† Self-adjusting house inertia calculation
  - üîÑ Supports comfort profiles via an aggressiveness setting
  - üìà ApexCharts examples included for visualization

-----
> **Note:**  
> Holiday mode is only active when Summer mode is *not* active.  
> If the outdoor temperature is above the summer threshold, Summer mode will always take priority over Holiday mode.  
> This means that heating will be minimized during warm periods, even if Holiday mode is enabled.
----
## Add PumpSteer to HACS as a Custom Repository

If PumpSteer is not yet available in the default HACS store, you can add it manually as a custom repository:

In Home Assistant, go to HACS in the sidebar.
Click the three dots menu (‚ãÆ) in the top right corner, and select Custom repositories.
In the "Repository" field, enter:
Code
https://github.com/JohanAlvedal/PumpSteer
Set the category to Integration.
Click Add.
PumpSteer will now appear under HACS > Integrations. Click Install to add it.
Restart Home Assistant after installation.
Continue with the configuration steps as described above.
Note:
As long as PumpSteer is not in the official HACS store, you need to repeat these steps if you reinstall HACS or clear its configuration.

-----

## üîß Installation & Configuration

Follow these three steps to get PumpSteer up and running.

### Step 1: Create Helper Entities (via Packages)

To make setup as easy as possible, this project includes a package file that creates all the necessary `input_number` and `input_text` helpers for you.

1.  **Download the `pumpsteer_package.yaml` file** from the repository.

2.  Place this file in your `/config/packages/` directory. If the `packages` directory does not exist at the root of your `/config` folder, you will need to create it.

3.  **Enable packages** in your main `configuration.yaml` file. If you haven't already, add the following lines. If you already have a `homeassistant:` section, just add the `packages:` line to it.

    ```yaml
    homeassistant:
      packages: !include_dir_named packages
    ```

4.  **Restart Home Assistant.** After restarting, all the required helpers (listed in the "Helper Entities Reference" section below) will be available.

### Step 2: Install the Custom Component

This is the standard procedure for installing a custom component.

1.  Place the `pumpsteer` directory (which contains `sensor.py`, `pre_boost.py`, etc.) in your Home Assistant `custom_components` folder.
2.  Restart Home Assistant again.

### Step 3: Add the Integration

1.  Navigate to **Settings \> Devices & Services \> Add Integration**.
2.  Search for and select **PumpSteer**.
3.  In the configuration dialog, select the helper entities that were created by the package file.

-----

## üìÑ Helper Entities Reference

Using the provided `pumpsteer_package.yaml` file will create the following entities. You can adjust their values from the Home Assistant UI in **Settings \> Devices & Services \> Helpers**.

| Type | Description |
| :--- | :--- |
| `sensor` | Indoor temperature sensor (you must provide this) |
| `sensor` | Real outdoor temperature sensor (you must provide this) |
| `sensor` | Electricity price sensor (you must provide this, e.g., Nordpool or Tibber) |
| `input_text` | Stores the hourly forecast temperatures (CSV string, 24 values) |
| `input_number`| Your desired target indoor temperature |
| `input_number`| The outdoor temperature threshold for activating Summer Mode |
| `input_number` | The aggressiveness level for savings vs. comfort (0.0 to 5.0) |
| `input_number` | The calculated house inertia (you can let PumpSteer manage this or override it) |

-----

## üß™ Forecast Format

The `input_text` entity for the temperature forecast must contain **of max 24 comma-separated values** representing the hourly forecasted outdoor temperatures for the next 24 hours:

```text
-3.5,-4.2,-5.0,-4.8,... (24 values total)
```

If the string is invalid or incomplete, the sensor will log a warning and temporarily suspend calculations until valid data is available.

-----

## üìä Sensor Outputs

PumpSteer creates two sensors.

### 1\. `sensor.pumpsteer` (Control Sensor)

This sensor provides the calculated virtual temperature.

**State:** The fake outdoor temperature (`¬∞C`) that should be sent to your heat pump.

**Attributes:**

| Attribute | Meaning |
| :--- | :--- |
| `L√§ge` | The current operating mode. Can be: `heating`, `neutral`, `braking_by_temp`, `summer_mode`, `preboost`, `braking_mode` |
| `Ute (verklig)` | The current temperature from the real outdoor sensor |
| `Inne (m√•l)` | Your desired indoor temperature |
| `Inne (verklig)` | The current indoor temperature |
| `Inertia` | How slowly the house reacts to outdoor temp changes (higher = better insulated) |
| `Aggressiveness` | From 0.0 (passive) to 5.0 (aggressive saving) |
| `Summer threshold` | The outdoor temp threshold to disable heat control |
| `Elpriser (prognos)` | Hourly electricity prices from your price sensor |
| `Pre-boost Aktiv` | True if pre-boost or braking is active (pauses inertia calculation) |

### 2\. `sensor.pumpsteer_future_strategy` (Diagnostic Sensor)

This sensor provides insights into *why* the system is making its decisions.

**State:**
The number of upcoming hours that are identified as both cold and expensive.

**Attributes:**

| Attribute | Meaning |
| :--- | :--- |
| `preboost_expected_in_hours` | How many hours in advance the system will start pre-boosting, based on house inertia. |
| `first_preboost_hour` | The clock time (e.g., "18:00") for the next expected pre-boost event. |
| `cold_and_expensive_hours_next_6h` | Total number of hours identified as "cold & expensive" in the next 6 hours. |
| `expensive_hours_next_6h` | Total number of hours considered "expensive" in the next 6 hours. |
| `braking_price_threshold_percent` | The current price threshold (as % of max price) for activating braking mode. |

-----

## Aggressiveness ‚Äì What Does It Do?

Aggressiveness (0.0 to 5.0) controls the trade-off between energy savings and indoor comfort. It affects both when heating is reduced (braking) and when extra heating is added (pre-boost).

| Setting | Braking behavior | Pre-boost behavior |
| :--- | :--- | :--- |
| **Low** (e.g., 0-1) | Rarely brakes, only at the absolute highest prices. | Boosts more easily to prioritize comfort. |
| **High** (e.g., 4-5) | Brakes early and often, even for moderate price peaks. | Boosts only in the most necessary cases to save energy. |

**Higher aggressiveness saves more money, but may reduce indoor comfort.**

-----

## üìà ApexCharts Examples

### Visualizing Temperatures

```yaml
type: custom:apexcharts-card
header:
  title: PumpSteer Temperature Control
graph_span: 24h
span:
  start: day
series:
  - entity: sensor.pumpsteer
    name: Fake Outdoor Temp
  - entity: sensor.ute_verklig_temp
    name: Real Outdoor Temp
  - entity: sensor.inne_verklig_temp
    name: Indoor Temp
  - entity: input_number.varmepump_target_temp
    name: Target Temp
    stroke_width: 2
    curve: stepline
```

### Visualizing Future Strategy

```yaml
type: custom:apexcharts-card
header:
  title: PumpSteer - Future Threats
chart_type: bar
graph_span: 24h
series:
  - entity: sensor.pumpsteer_future_strategy
    name: Cold & Expensive Hours
    attribute: cold_and_expensive_hours_next_6h
  - entity: sensor.pumpsteer_future_strategy
    name: Expensive Hours
    attribute: expensive_hours_next_6h
```

-----

## üß† How It Works

PumpSteer calculates a "fake" outdoor temperature to nudge your heat pump to either:

  - **Pre-boost:** Heat more when prices and temperatures are low, before an upcoming cold and expensive peak.
  - **Brake:** Avoid heating when prices are at their highest.
  - **Normal:** Gently adjust heating to maintain comfort with minimal cost.
  - **Summer Mode:** Stand down when it's warm outside.

---

> üí° **Example setup:**  
> In my setup, a [Ohmigo Ohm On WiFi](https://www.ohmigo.io/product-page/ohmigo-ohm-on-wifi) device is used to control the boiler. It acts as a simple WiFi-connected relay that is switched via Home Assistant, allowing PumpSteer to influence the heating system indirectly by controlling when the boiler is allowed to run.

-----

## üí¨ Logging and Troubleshooting

  - Warnings and errors are logged to the standard Home Assistant log.
  - If required sensor data is unavailable, PumpSteer will show `unavailable` and retry automatically.
  - The house inertia value is calculated and updated automatically unless you provide a manual override via an `input_number`.

-----

## A Note From The Developer

This integration was built by an amateur developer with the powerful assistance of Google's Gemini and Copilot. It is the result of a passion for smart homes, a lot of trial and error, and many, many Home Assistant restarts.

Please consider this a **beta product** in the truest sense.

If you are knowledgeable in this area, constructive feedback, suggestions, and contributions are warmly welcomed. Please be patient, as this is a learning project.

-----

## üîó Links

  - [Issue Tracker](https://github.com/JohanAlvedal/pumpsteer/issues)

-----

## üìÑ License

¬© Johan √Ñlvedal
